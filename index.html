import React, { useEffect, useState, useCallback } from "react";
let bridge: any = null;
try { bridge = require("@vkontakte/vk-bridge"); } catch (e) { bridge = { send: async () => ({}), supports: () => false }; }

type User = { id: number; first_name: string; last_name: string; photo_200?: string } | null;

// –≠—Ç–∞–ø—ã —è–∏—Ü (—Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏)
const eggStages = [
  { name: "–ë—Ä–æ–Ω–∑–æ–≤–æ–µ —è–π—Ü–æ", clicks: 20, image: "/images/egg1.png" },
  { name: "–°–µ—Ä–µ–±—Ä—è–Ω–æ–µ —è–π—Ü–æ", clicks: 50, image: "/images/egg2.png" },
  { name: "–ó–æ–ª–æ—Ç–æ–µ —è–π—Ü–æ", clicks: 100, image: "/images/egg3.png" },
  { name: "–ê–ª–º–∞–∑–Ω–æ–µ —è–π—Ü–æ", clicks: 200, image: "/images/egg4.png" },
  { name: "–ú–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —è–π—Ü–æ", clicks: 500, image: "/images/egg5.png" },
];

export default function VKEggClicker() {
  const [user, setUser] = useState<User>(null);
  const [ready, setReady] = useState(false);
  const [score, setScore] = useState(0);
  const [eggIndex, setEggIndex] = useState(0);
  const [progress, setProgress] = useState(0);
  const [shake, setShake] = useState(false);
  const [highScore, setHighScore] = useState<number>(() => Number(localStorage.getItem("vkmini_egg_highscore") || 0));
  const [leaderboard, setLeaderboard] = useState<Array<{ name: string; score: number }>>(() => {
    const raw = localStorage.getItem("vkmini_egg_leaderboard");
    return raw ? JSON.parse(raw) : [];
  });
  const [theme, setTheme] = useState<"light" | "dark">("dark");

  useEffect(() => {
    (async () => {
      try {
        if (bridge?.send) {
          await bridge.send("VKWebAppInit");
          const info = await bridge.send("VKWebAppGetUserInfo");
          setUser({ id: info.id, first_name: info.first_name, last_name: info.last_name, photo_200: info.photo_200 });
        }
      } catch (e) {
        console.warn("Bridge unavailable in preview:", e);
      } finally {
        setReady(true);
      }
    })();
  }, []);

  const clickHandler = useCallback(() => {
    setScore(s => s + 1);
    setProgress(p => {
      const maxClicks = eggStages[eggIndex].clicks;
      const newProgress = p + 1;
      if (newProgress >= maxClicks) {
        setEggIndex(i => Math.min(i + 1, eggStages.length - 1));
        return 0;
      }
      return newProgress;
    });
    setShake(true);
    setTimeout(() => setShake(false), 150);
    if (navigator.vibrate) navigator.vibrate(10);
  }, [eggIndex]);

  const resetGame = () => {
    setScore(0);
    setEggIndex(0);
    setProgress(0);
  };

  const saveHighScore = useCallback(() => {
    setHighScore(h => {
      const best = Math.max(h, score);
      localStorage.setItem("vkmini_egg_highscore", String(best));
      const name = user ? `${user.first_name} ${user.last_name}` : "–ì–æ—Å—Ç—å";
      const updated = [...leaderboard, { name, score }].sort((a, b) => b.score - a.score).slice(0, 10);
      setLeaderboard(updated);
      localStorage.setItem("vkmini_egg_leaderboard", JSON.stringify(updated));
      return best;
    });
  }, [score, user, leaderboard]);

  useEffect(() => {
    if (score > highScore) saveHighScore();
  }, [score, highScore, saveHighScore]);

  const share = async () => {
    const text = `–Ø –Ω–∞–±–∏–ª ${score} –∫–ª–∏–∫–æ–≤ –≤ –ö–ª–∏–∫–µ—Ä–µ —è–∏—Ü!`; 
    try {
      if (bridge?.send && bridge.supports?.("VKWebAppShare")) {
        await bridge.send("VKWebAppShare", { link: window.location.href });
      } else if (navigator.share) {
        await navigator.share({ title: "VK Egg Clicker", text, url: window.location.href });
      } else {
        await navigator.clipboard.writeText(window.location.href);
        alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
      }
    } catch (e) {
      console.warn(e);
    }
  };

  const currentEgg = eggStages[eggIndex];
  const progressPercent = Math.round((progress / currentEgg.clicks) * 100);

  return (
    <div className={"min-h-screen w-full flex items-center justify-center p-4 " + (theme === "dark" ? "bg-slate-950 text-slate-100" : "bg-slate-50 text-slate-900")}>
      <div className="w-full max-w-md grid gap-4 text-center">
        <header className="flex items-center gap-3">
          {user?.photo_200 ? (
            <img src={user.photo_200} alt="avatar" className="w-10 h-10 rounded-full" />
          ) : (
            <div className="w-10 h-10 rounded-full bg-slate-700" />
          )}
          <div className="flex-1">
            <h1 className="text-xl font-semibold">–ö–ª–∏–∫–µ—Ä –Ø–∏—Ü</h1>
            <p className="text-sm opacity-70">–†–∞–∑–±–µ–π –≤—Å–µ —è–π—Ü–∞!</p>
          </div>
          <button onClick={() => setTheme(t => (t === "dark" ? "light" : "dark"))} className="px-3 py-1.5 rounded-2xl shadow bg-slate-800/60 hover:bg-slate-700/60 dark:bg-slate-200/80 dark:hover:bg-slate-300/80 text-sm">
            {theme === "dark" ? "‚òÄÔ∏è" : "üåô"}
          </button>
        </header>

        <div className="flex justify-center">
          <button
            onClick={clickHandler}
            className={`relative w-48 h-48 rounded-full bg-gradient-to-tr from-yellow-300 to-orange-500 shadow-xl active:scale-95 transition-transform ${shake ? "animate-wiggle" : ""}`}
          >
            <span className="absolute inset-0 flex items-center justify-center">
              <img 
                src={currentEgg.image} 
                alt={currentEgg.name} 
                className="w-40 h-40 object-contain select-none pointer-events-none"
              />
            </span>
          </button>
        </div>

        <style>
          {`
            @keyframes wiggle {
              0% { transform: rotate(0deg); }
              25% { transform: rotate(-8deg); }
              50% { transform: rotate(8deg); }
              75% { transform: rotate(-8deg); }
              100% { transform: rotate(0deg); }
            }
            .animate-wiggle {
              animation: wiggle 0.15s ease-in-out;
            }
          `}
        </style>

        <div className="w-full bg-slate-700/30 rounded-full h-4 overflow-hidden">
          <div className="h-4 bg-green-500" style={{ width: `${progressPercent}%` }} />
        </div>
        <p className="text-sm">{currentEgg.name} ‚Äî {progress}/{currentEgg.clicks}</p>

        <section className="grid gap-2">
          <div className="flex items-center justify-between text-sm opacity-80"><span>–¢–µ–∫—É—â–∏–π —Å—á—ë—Ç</span><span className="font-semibold">{score}</span></div>
          <div className="flex items-center justify-between text-sm opacity-80"><span>–†–µ–∫–æ—Ä–¥</span><span className="font-semibold">{highScore}</span></div>
        </section>

        <div className="grid grid-cols-2 gap-3">
          <button onClick={resetGame} className="rounded-2xl px-4 py-3 shadow bg-slate-700 hover:bg-slate-800 text-white font-medium">–°–±—Ä–æ—Å</button>
          <button onClick={share} className="rounded-2xl px-4 py-3 shadow bg-emerald-600 hover:bg-emerald-700 text-white font-medium">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>

        <section className="grid gap-2">
          <h2 className="text-base font-semibold">–õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–æ–ø-10</h2>
          <ul className="grid gap-1">
            {leaderboard.length === 0 && <li className="text-sm opacity-60">–ï—â—ë –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Äî —Å—ã–≥—Ä–∞–π –ø–µ—Ä–≤—ã–º!</li>}
            {leaderboard.map((row, i) => (
              <li key={i} className="flex items-center justify-between text-sm">
                <span className="opacity-80">{i + 1}. {row.name}</span>
                <span className="font-semibold">{row.score}</span>
              </li>
            ))}
          </ul>
        </section>

        <footer className="text-xs opacity-60">
          –ö–ª–∏–∫–µ—Ä —è–∏—Ü –¥–ª—è VK Mini Apps. –ö–ª–∏–∫–∏ —Ä–∞–∑–±–∏–≤–∞—é—Ç —è–π—Ü–∞, –æ—Ç–∫—Ä—ã–≤–∞—è –Ω–æ–≤—ã–µ —É—Ä–æ–≤–Ω–∏.
        </footer>
      </div>
    </div>
  );
}
